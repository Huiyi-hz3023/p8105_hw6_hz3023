---
title: "p8105_hw6_hz3023"
author: "Huiyi Zhu"
date: "2025-12-04"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prepare
```{r}
library(tidyverse)
library(broom)
library(modelr)
library(ggplot2)
```

## Problem 1
```{r}
homicide=read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") |> 
  mutate(
    city_state = str_c(city, ", ", state),
    victim_age = as.numeric(victim_age),
    solved = disposition == "Closed by arrest")|>
  filter(
    !city_state %in% c(
      "Dallas, TX",
      "Phoenix, AZ",
      "Kansas City, MO",
      "Tulsa, AL")) |>
  filter(victim_race %in% c("White", "Black"))
```
```{r}
baltimore=homicide|>
  filter(city_state == "Baltimore, MD")|>
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = _,
    family = binomial())

baltimore_tidy= broom::tidy(baltimore, conf.int = TRUE) |> 
  mutate(
    OR = exp(estimate),
    OR_low = exp(conf.low),
    OR_high = exp(conf.high))

baltimore_tidy |>
  filter(term == "victim_sexMale") |>
  select(term, OR, OR_low, OR_high) |> 
  knitr::kable(digits=2)
```

```{r}
city_OR <- homicide |>
  nest(data = -city_state) |>
  mutate(
    model = map(data,\(df) 
                glm(solved ~ victim_age + victim_sex + victim_race,
        data   = df,
        family = binomial())),
    tidy= map(model,\(mod) broom::tidy(mod, conf.int = TRUE) |>
        mutate(
          OR=exp(estimate),
          OR_low  = exp(conf.low),
          OR_high = exp(conf.high))))|>
  select(city_state, tidy) |>
  unnest(tidy) |>
  filter(term == "victim_sexMale") |>
  select(city_state, OR, OR_low, OR_high)
city_OR
```
```{r}
city_OR |>
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ggplot(aes(x = OR, y = city_state)) +
  geom_point() +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Adjusted odds ratio (male vs female victims)",
    y = "City",
    title = "Adjusted ORs for solving homicides across cities")
```

Most estimated odds ratios are below 1, suggesting that homicides of male victims are generally less likely to be solved than those of female victims. However, many confidence intervals cross 1, indicating considerable uncertainty and limited evidence of a consistent or statistically robust sex difference across cities.


## Problem 2
```{r}
library(p8105.datasets)
data("weather_df")
set.seed(20)
centralpark = weather_df |>
  filter(name == "CentralPark_NY") |> 
  drop_na(tmax,tmin,prcp) |> 
  modelr::bootstrap(n=5000) |> 
  mutate(
    fit=map(strap, ~lm (tmax~tmin+prcp,data=.x)),
    r2=map_dbl(fit, ~broom::glance (.x)$r.squared),
    beta_ratio=map_dbl(fit, ~ {
      coefs <-broom::tidy (.x)
      beta1 <-coefs |> filter(term=="tmin") |> pull(estimate)
      beta2 <-coefs |> filter(term=="prcp") |> pull(estimate)
      beta1/beta2
    })
  ) |> 
  select (-strap,-fit)
centralpark
```
```{r}
centralpark |>
  ggplot(aes(x = r2)) +
  geom_density() +
  labs(
    title = expression("Bootstrap Distribution of " ~ R^2),
    x = expression(R^2),
    y = "Density"
  ) +
  theme_minimal()
```

The bootstrap distribution of $R^2$ is unimodal and tightly concentrated, with most estimates between `r round(min(centralpark$r2),3)` and `r round(max(centralpark$r2),3)`. The peak around `r round(mean(centralpark$r2),3)`.


```{r}
centralpark |>
  ggplot(aes(x = beta_ratio)) +
  geom_density() +
  labs(
    title = expression("Bootstrap Distribution of " ~ hat(beta)[1] / hat(beta)[2]),
    x = expression(hat(beta)[1] / hat(beta)[2]),
    y = "Density"
  ) +
  theme_minimal()
```

The bootstrap distribution of $\hat\beta_1 / \hat\beta_2$ is extremely unstable. Because $\hat\beta_2$  is very close to zero in many bootstrap samples, the ratio becomes very large in magnitude, producing a distribution with long tails and a sharp spike near zero. This indicates that the ratio $\hat\beta_1 / \hat\beta_2$ is not a reliable quantity for inference in this model.

```{r}
centralpark |>
  summarize(
    r2_low   = quantile(r2, 0.025),
    r2_high  = quantile(r2, 0.975),
    ratio_low  = quantile(beta_ratio, 0.025),
    ratio_high = quantile(beta_ratio, 0.975)
  )
```

## Problem 3
```{r}
birthweight =
  read_csv("birthweight.csv") |>
  janitor::clean_names() |>
  mutate(
    babysex = factor(babysex, levels = c(1, 2),
                     labels = c("male", "female")),
    frace = factor(frace, levels = c(1, 2, 3, 4, 8, 9),
                   labels = c("white", "black", "asian","puerto_rican", "other", "unknown")),
    mrace = factor(mrace, levels = c(1, 2, 3, 4, 8),
                   labels = c("white", "black", "asian","puerto_rican", "other")),
    malform = factor(malform, levels = c(0, 1),
                     labels = c("absent", "present"))) |>
  drop_na()
  
```
```{r}
birth_model =
  lm(bwt ~ bhead + blength + gaweeks +
         ppbmi + wtgain + smoken +
         momage + mrace,
     data = birthweight)
```

I built the birthweight model using a combination of biological reasoning and exploratory analysis. Fetal growth variables (bhead, blength, gaweeks) were included because they are directly related to newborn size. Maternal health factors (ppbmi, wtgain, smoken) and demographics (momage, mrace) were added based on known associations with birth outcomes. I compared several candidate models and retained predictors that improved fit and were scientifically meaningful. The final model includes these key variables and shows reasonable residual patterns with no major violations of linear model assumptions.

```{r}
  birthweight |>
  add_predictions(birth_model) |>
  add_residuals(birth_model) |>
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.5) +
  labs(
    x = "Fitted birthweight",
    y = "Residuals",
     title = "Residuals vs Fitted Values") +
  theme_minimal()
```
```{r}
model_maineffects =
  lm(bwt ~ blength + gaweeks,
     data = birthweight)

model_interact =
  lm(bwt ~ bhead * blength * babysex,
     data = birthweight)
```

```{r}
cv_df =
  modelr::crossv_mc(birthweight, n = 100) |>
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble))
cv_df =
  cv_df |>
  mutate(
    main_mod = map(train, \(df)
      lm(bwt ~ bhead + blength + gaweeks +
                 ppbmi + wtgain + smoken +
                 momage + mrace,
         data = df)),
    maineffects_mod = map(train, \(df) lm(bwt ~ blength + gaweeks, data = df)),
    interact_mod = map(train, \(df) lm(bwt ~ bhead * blength * babysex, data = df))) |>
  mutate(
    rmse_main     = map2_dbl(main_mod,     test, \(mod, df) rmse(model = mod, data = df)),
    rmse_maineffects  = map2_dbl(maineffects_mod,  test, \(mod, df) rmse(model = mod, data = df)),
    rmse_interact = map2_dbl(interact_mod, test, \(mod, df) rmse(model = mod, data = df)))

cv_df |>
  select(starts_with("rmse")) |>
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_") |>
  mutate(model = fct_inorder(model)) |>
  ggplot(aes(x = model, y = rmse)) +
  geom_violin() +
  labs(
    title = "Cross-validated RMSE for Models",
    x = "Model",
    y = "RMSE"
  ) +
  theme_minimal()
```

