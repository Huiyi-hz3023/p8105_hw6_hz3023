---
title: "p8105_hw6_hz3023"
author: "Huiyi Zhu"
date: "2025-12-04"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prepare
```{r}
library(tidyverse)
library(broom)
library(modelr)
library(ggplot2)
```

## Problem 1
```{r}
homicide=read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv") |> 
  mutate(
    city_state = str_c(city, ", ", state),
    victim_age = as.numeric(victim_age),
    solved = disposition == "Closed by arrest")|>
  filter(
    !city_state %in% c(
      "Dallas, TX",
      "Phoenix, AZ",
      "Kansas City, MO",
      "Tulsa, AL")) |>
  filter(victim_race %in% c("White", "Black"))
```
```{r}
baltimore=homicide|>
  filter(city_state == "Baltimore, MD")|>
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = _,
    family = binomial())

baltimore_tidy= broom::tidy(baltimore, conf.int = TRUE) |> 
  mutate(
    OR = exp(estimate),
    OR_low = exp(conf.low),
    OR_high = exp(conf.high))

baltimore_tidy |>
  filter(term == "victim_sexMale") |>
  select(term, OR, OR_low, OR_high) |> 
  knitr::kable(digits=2)
```

```{r}
city_OR <- homicide |>
  nest(data = -city_state) |>
  mutate(
    model = map(data,\(df) 
                glm(solved ~ victim_age + victim_sex + victim_race,
        data   = df,
        family = binomial())),
    tidy= map(model,\(mod) broom::tidy(mod, conf.int = TRUE) |>
        mutate(
          OR=exp(estimate),
          OR_low  = exp(conf.low),
          OR_high = exp(conf.high))))|>
  select(city_state, tidy) |>
  unnest(tidy) |>
  filter(term == "victim_sexMale") |>
  select(city_state, OR, OR_low, OR_high)
city_OR
```
```{r}
city_OR |>
  mutate(city_state = fct_reorder(city_state, OR)) |>
  ggplot(aes(x = OR, y = city_state)) +
  geom_point() +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Adjusted odds ratio (male vs female victims)",
    y = "City",
    title = "Adjusted ORs for solving homicides across cities")
```

Most estimated odds ratios are below 1, suggesting that homicides of male victims are generally less likely to be solved than those of female victims. However, many confidence intervals cross 1, indicating considerable uncertainty and limited evidence of a consistent or statistically robust sex difference across cities.


## Problem 2
```{r}
library(p8105.datasets)
data("weather_df")
set.seed(20)
centralpark = weather_df |>
  filter(name == "CentralPark_NY") |> 
  drop_na(tmax,tmin,prcp) |> 
  modelr::bootstrap(n=5000) |> 
  mutate(
    fit=map(strap, ~lm (tmax~tmin+prcp,data=.x)),
    r2=map_dbl(fit, ~broom::glance (.x)$r.squared),
    beta_ratio=map_dbl(fit, ~ {
      coefs <-broom::tidy (.x)
      beta1 <-coefs |> filter(term=="tmin") |> pull(estimate)
      beta2 <-coefs |> filter(term=="prcp") |> pull(estimate)
      beta1/beta2
    })
  ) |> 
  select (-strap,-fit)
centralpark
```
```{r}
centralpark |>
  ggplot(aes(x = r2)) +
  geom_density() +
  labs(
    title = expression("Bootstrap Distribution of " ~ R^2),
    x = expression(R^2),
    y = "Density"
  ) +
  theme_minimal()
```

The bootstrap distribution of $R^2$ is unimodal and tightly concentrated, with most estimates between `r round(min(centralpark$r2),3)` and `r round(max(centralpark$r2),3)`. The peak around `r round(mean(centralpark$r2),3)`.


```{r}
centralpark |>
  ggplot(aes(x = beta_ratio)) +
  geom_density() +
  labs(
    title = expression("Bootstrap Distribution of " ~ hat(beta)[1] / hat(beta)[2]),
    x = expression(hat(beta)[1] / hat(beta)[2]),
    y = "Density"
  ) +
  theme_minimal()
```

The bootstrap distribution of $\hat\beta_1 / \hat\beta_2$ is extremely unstable. Because $\hat\beta_2$  is very close to zero in many bootstrap samples, the ratio becomes very large in magnitude, producing a distribution with long tails and a sharp spike near zero. This indicates that the ratio $\hat\beta_1 / \hat\beta_2$ is not a reliable quantity for inference in this model.

```{r}
centralpark |>
  summarize(
    r2_low   = quantile(r2, 0.025),
    r2_high  = quantile(r2, 0.975),
    ratio_low  = quantile(beta_ratio, 0.025),
    ratio_high = quantile(beta_ratio, 0.975)
  )
```

## Problem 3
